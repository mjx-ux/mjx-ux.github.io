---
layout:     post
title:      JVM-运行时的数据区域
subtitle:   2023-08-14每日一题
date:       2023-08-14
author:     JunXiang Ma
header-img: img/post-bg-cook.jpg
catalog: true
tags:
    - 每日一题
---

# JVM-运行时的数据区域

本文章考虑在Java8下，同时为Hot Spot虚拟机

JVM的运行时数据区，不同虚拟机实现可能略微不同，但都会遵从Java虚拟机规范，Java 8虚拟机规范规定，Java虚拟机所管理的内存将会包括一下几个运行时数据区域：

1. 程序计数器（Program Counter Register）
2. Java虚拟机栈（Java Virtual Machine Stack）
3. 本地方法栈（Native Method Stack）
4. Java堆（Java Heap）
5. 方法区（Method Area）

## 程序计数器（Program Counter Register）

程序计数器是一块较小的内存空间，它可以看作是当前线程所执行的字节码的行号指示器。

Java中最小的执行单元是线程，因为虚拟机是多线程的，每一个线程互相抢夺CPU时间片，程序计数器就是存储这些指令去做什么，比如循环、跳转、异常处理等等。



从字节码运行的原理来看，单线程模型下的程序计数器貌似可有可无，字节码解析器会按照顺序将字节码翻译成固定操作，即使遇到分支跳转，也无碍程序正确运行下去。然而，现实中的程序往往是通过多线程协作来完成一个任务的，CPU会为每个线程分配一定的时间片，一个线程在其时间片耗尽之后会挂起，直到它再次获得时间片后才会重新运行。为了确保程序正确运行，线程必须从挂起的地方重新执行。**有了程序计数器，就可以保证在涉及线程上下文切换的情景下，程序依然能够正确无误地运行下去**。

1. 程序计数器是一块内存空间几乎可以忽略不记，也是运行速度最快得区域

2. 在JVM规范中，每一个线程都有自己得程序计数器，是线程私有的，声明周期和线程生命周期保持一致

3. 任何时间一个线程只有一个方法在执行，也就是当前方法。程序计数器会存储当前线程正在执行的Java方法的JVM指令地址。如果执行的是native方法，则是未指定值（undefined）

4. 它是程序控制流的指示器，分支，循环，跳转，异常处理，线程恢复等基础功能的根基

5. 字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令

6. 它是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域

   

## Java虚拟机栈（Java Virtual Machine Stack）

JVM会给每个线程都分配一个私有的内存空间，称为Java虚拟机栈（Java Virtual Machine Stack）。Java虚拟机栈随着线程的创建而创建，JVM只会对其执行两种操作：方法的栈帧的入栈和出栈。也就是说，Java虚拟机栈是存储栈帧的后进先出队列（LIFO）。

每个方法的执行过程，都会伴随着方法的栈帧的创建、入栈和出栈。栈帧是用来存储局部数据和部分过程结果的数据结构，主要包含 **局部变量表**（Local Variable Table）、**操作数栈**（Operand Stack）、**指向当前方法所属类的运行时常量池的引用**（Runtime Constant Pool Reference）

![img](https://pic2.zhimg.com/80/v2-5e4f9f4bb76dd61559d097377df7f3dd_1440w.webp)



## 本地方法栈（Native Method Stack）

本地方法栈用于管理本地方法的调用，本地方法栈既可以被实现成固定大小，也可以实现成可动态地扩展和收缩，因此在特定的场景下也会抛出StackOverflowError异常和OutOfMemoryError异常。



## Java堆（Java Heap）

Java堆时运行时数据区域中最大的一块，绝大部分对象（包括类实例和数组）都在上面存储。堆是所有线程所共享的，随着JVM的启动而创建。我们通过new创建出来的对象都分配于堆中，而且无序主动释放对象内存，统一由GC进行管理回收（**可以参照JVM-GC文章**）。当堆中没有足够的内存来创建对象时，就会抛出OutOfMemoryError异常

## 方法区（Method Area）

## 引用

1.[JVM运行时数据区（详解+面试）_jvm运行时会分配哪些内存_glenzhang(ty)的博客-CSDN博客](https://blog.csdn.net/qdzjo/article/details/115741193)

2.[深入解析Java的运行时数据区 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/102431019)
