---
layout:     post
title:      JVM-GC
subtitle:   2023-8-10每日一题
date:       2023-8-10
author:     JunXiang Ma
header-img: img/the-first.png
catalog:   true
tags:

    - 每日一题
---

# GC(Java垃圾回收机制)

GC：Garbage  Collection

Java 的垃圾回收器并不是特指一种，Java官方本身就提供了很多个GC回收器供用户选择，还有各个Java虚拟机厂商（例如 Azul 的PCG、C4）也自己设计开发了很多优秀的垃圾回收器。

**Stop The World** 也是一个很重要的关键词，它会在任何一种GC算法中发生，其实可以把它理解为JVM GC在清理内存时，整个程序的停顿时间。当 Stop The World 发生时，除GC所需的线程外，所有的线程都进入等待状态，直到 GC 任务完成。每一代的Java垃圾回收器，都把缩减 **Stop The World** 停顿时间作为很重要的目标。



**本文仅以 HotSpot 虚拟机展开，详解它的垃圾回收机制**

## 如何确定是垃圾
### 引用计数算法

引用计数算法就是给对象添加了一个引用计数器，每当有地方引用了它，计数器就加1，引用失效时，计数器就减1。

当触发了内存回收的时候，GC会把引用计数器等于0的找出来，释放掉



这时候就会出现了一个问题：两个对象互相引用，引用计数器的值永远是1，无法确定是否是垃圾了。

```java
static class Test{
    public Test instance;
}

public void run() {
    Test t1 = new Test();
    Test t2 = new Test();
    t1.instance = t2;
    t2.instance = t1;
}
```

引入了另外一种算法

### 可达性分析算法（根搜索算法）

其实不止是Java，C# 也是使用可达性分析算法来判断对象是否存活的，这个算法也可以称之为根搜索算法，也可以叫可达性分析算法

这个算法的基本原理是通过一系列可被作为 **GC Roots** 的根对象来作为起始节点，从这些节点开始，根据引用关系向下搜索，搜索过程的就是一条**引用链（Reference Chain）**，没有在这个链条上面的对象，也就是根节点（GC Roots）通过引用链不可达到这个对象时，就认为这个对象是可以被回收的。

#### 哪些对象可以当作GC Root（根节点）

1. 在虚拟机栈帧中引用的对象：线程调用方法时，使用或产生的参数、局部变量、临时变量等
2. 在方法区中，类的引用类型静态变量或常量
3. 本地方法栈中的JNI引用的对象
4. 在JVM内部的对象：基本数据类型的Clas对象，一些常驻的异常对象（NullPointerException）